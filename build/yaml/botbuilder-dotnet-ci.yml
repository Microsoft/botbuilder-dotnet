#
# Build configuration file to run build BotBuilder-DotNet-master-CI-PR on azure pipelines
#
name: TestBuild-$(Build.BuildId)
variables:
  ApiCompatVersion: 4.6.3
  BotBuilderDll: Microsoft.Bot.Builder.AI.Luis,Microsoft.Bot.Builder.AI.QnA,Microsoft.Bot.Builder.ApplicationInsights,Microsoft.Bot.Builder.Azure,Microsoft.Bot.Builder.Dialogs,Microsoft.Bot.Builder.Integration.ApplicationInsights.Core,Microsoft.Bot.Builder.Integration.AspNet.Core,Microsoft.Bot.Builder.TemplateManager,Microsoft.Bot.Builder.Testing,Microsoft.Bot.Builder,Microsoft.Bot.Configuration,Microsoft.Bot.Connector,Microsoft.Bot.Schema,Microsoft.Bot.Streaming
  BuildConfiguration: Debug-Windows
  BuildPlatform: any cpu
  CoverallsToken: define this in Azure
  GitHubCommentApiKey: define this in Azure
  IsBuildServer: true
  Parameters.solution: Microsoft.Bot.Builder.sln
  PreviewPackageVersion: 4.6.0-preview-$(Build.BuildNumber)
  ReleasePackageVersion: 4.6.0-preview-$(Build.BuildNumber)

#Multi-configuration and multi-agent job options are not exported to YAML. Configure these options using documentation guidance: https://docs.microsoft.com/vsts/pipelines/process/phases
stages:
- stage: Build
  jobs:
  - job: Debug_Windows_Configuration
    pool:
      name: Hosted Windows 2019 with VS2019
      demands:
      - msbuild
      - visualstudio
    variables:
      BuildConfiguration: Debug-Windows
    steps:
    - script: echo Executing this 1
    #- template: ci-build-steps.yml
  - job: Release_Windows_Configuration
    pool:
      name: Hosted Windows 2019 with VS2019
      demands:
      - msbuild
      - visualstudio
    variables:
      BuildConfiguration: Release-Windows
    steps:
    - script: echo Executing this 2
    #- template: ci-build-steps.yml

- stage: API_Compatibility_Validation
  dependsOn: Build
  jobs:
  - job: generate_thread_variables
    pool:
      name: Hosted Windows 2019 with VS2019
    steps:
    - powershell: |
       $threads = '';

       $env:BotBuilderDll.Split(",") | ForEach {
           $library = $_.Trim()
           Write-Host $library

           $threadName = $library.Split(".")[-1];
           $threads += "{'" + $threadName + "':{'BotBuilderDll':'" + $library + "'}, ";
         }
       $threads = $threads.TrimEnd(' ').TrimEnd(',') + "}";
       $threads

       "##vso[task.setVariable variable=THREADS;isOutput=true]$threads"
      name: generate_threads
    - script: echo "$(generate_threads.THREADS)"

  - job: run_threads
    dependsOn: generate_thread_variables
    variables:
      THREADS: $[ dependencies.generate_thread_variables.outputs['generate_threads.THREADS'] ]
    pool:
      name: Hosted Windows 2019 with VS2019
      timeoutInMinutes: 10
    strategy:
      maxParallel: 10
      matrix: $[ dependencies.generate_thread_variables.outputs['generate_threads.THREADS'] ]
    steps:
    - script: echo "$(BotBuilderDll)"
    #- template: ci-api-validation-steps.yml

- stage: Post_Results_to_GitHub
  dependsOn: API_Compatibility_Validation
  jobs:
  - job: Post_to_GitHub
    pool:
      name: Hosted Windows 2019 with VS2019
    variables:
      BuildConfiguration: Release-Windows
    steps:
    - script: echo Executing this 3
    #- template: ci-post-to-github-steps.yml
